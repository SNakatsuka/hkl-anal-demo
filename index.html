<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>hkl-analysis-demo (HKL → |F|, E 正規化)</title>
  <link rel="stylesheet" href="./style.css" />
</head>
<body>
  <header>
    <h1>hkl-analysis-demo</h1>
    <small>build: 2026-01-23 15:30</small>
    <p>HKL（h k l I sigma）を読み込み、|F| と E 値を試算します（MVP）。</p>
  </header>

  <main>
    <section class="panel">
      <h2>1) ファイル読み込み</h2>
      <input id="fileInput" type="file" accept=".hkl,.HKL,.txt"/>
      <p class="hint">想定フォーマット: <code>h k l I sigma</code> の空白区切り（行コメントや空行は自動スキップ）</p>
    </section>

    <section class="panel">
      <h2>2) 概要</h2>
      <div id="summary">ファイル未読込</div>
    </section>

    <section class="panel">
      <h2>3) 出力</h2>
      <button id="downloadEcsv" disabled>E 値 CSV をダウンロード</button>
      <button id="downloadFcsv" disabled>|F| CSV をダウンロード</button>
    </section>

    <section class="panel">
      <h2>測定条件（Wilson plot 用）</h2>
    
      <label>
        波長 λ (Å):
        <input id="lambdaInput" type="number" step="0.00001" value="0.71073">
      </label>
      <br><br>
    
      <label>
        θ_min (deg):
        <input id="thetaMinInput" type="number" step="0.001" value="2.2380">
      </label>
      <br><br>
    
      <label>
        θ_max (deg):
        <input id="thetaMaxInput" type="number" step="0.001" value="30.3588">
      </label>
    
      <p class="hint">
        ※ いずれも任意入力ですが、Wilson プロットには λ と θ_max が必要です。<br>
        ※ HKL のみでも解析できますが、正確な分解能計算が可能になります。
      </p>
    </section>

    <section class="panel">
      <h2>Wilson-like プロット（近似：R = h²+k²+l²）</h2>
      <div id="wilsonContainer" style="overflow:auto">
        <!-- SVG をここに動的に生成 -->
      </div>
      <p class="hint">
        ※ ユニットセル未入力のため、d-spacing ではなく R=h²+k²+l² を横軸に用いた近似プロットです。<br>
        ※ 形状（高角側での落ち方）と品質の当たりを掴む目的に使えます。<br>
        ※ 絶対値ではなく“形”を見るためのプロットです。
      </p>
    </section>

    <section class="panel">
      <h2>E 分布ヒストグラム</h2>
      <div id="eHistContainer"></div>
      <p class="hint">
        ⟨|E²−1|⟩ に基づき、centro / acentro の推定を行います。<br>
        理想値：acentro ≈ 0.736, centro ≈ 0.968
      </p>
    </section>

    <section class="panel">
      <h2>系統消滅（Extinction）による格子心推定</h2>
      <div id="extContainer">未計算</div>
      <p class="hint">
        候補：P / I / C / F<br>
        ratio = forbidden / allowed が小さいほど格子心の可能性が高い。<br>
        ※ ロバスト統計（median + winsorize）により外れ値の影響を抑えています。
      </p>
    </section>

    <section class="panel">
      <h2>空間群候補（簡易）</h2>
      <div id="sgContainer">未計算</div>
      <p class="hint">
        格子心（I/C/F/P）と E分布（centro/acentro）に基づく初期推定。<br>
        完全な決定ではありませんが、SHELX の初期段階と同等の役割を持ちます。
      </p>
    </section>
    
    <section class="panel">
      <h2>進捗</h2>
      <div style="display:flex; align-items:center; gap:12px;">
        <progress id="progress" value="0" max="100" style="width: 320px;"></progress>
        <span id="progressPct">0%</span>
      </div>
      <div id="progressInfo" class="hint">待機中…</div>
    </section>

    <section class="panel">
      <h2>ログ</h2>
      <pre id="log"></pre>
    </section>
  </main>

  <footer>
    <small>© 2026 SHELX-Next Project（試作）</small>
  </footer>

  <script type="module" src="utils/hkl.js"></script>
  <script type="module" src="utils/e_normalize.js"></script>
  <script type="module" src="./app.js"></script>
</body>
</html>
