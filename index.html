<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>hkl-analysis-demo (HKL → |F|, E 正規化)</title>
  <link rel="stylesheet" href="./style.css" />
</head>
<body>
  <header>
    <h1>hkl-analysis-demo</h1>
    <small>build: 2026-01-31 22:10</small>
    <p>HKL（h k l I sigma）を読み込み、|F| と E 値を試算します（MVP）。</p>
  </header>

  <main>
    <section class="panel">
      <h2>測定条件（Wilson plot 用）</h2>

      <!-- ★ ID を app.js/params.js が期待する名前に合わせる -->
      <label>
        波長 λ (Å):
        <input id="lambda" type="number" step="0.00001" value="0.71073">
      </label>
      <br><br>

      <!-- θ_min は現状未使用なら UI にだけ残す（IDは自由）。使う予定があれば params.js へ実装を -->
      <label>
        θ_min (deg):
        <input id="thetaMin" type="number" step="0.001" value="2.2380">
      </label>
      <br><br>

      <label>
        θ_max (deg):
        <input id="thetaMax" type="number" step="0.001" value="30.3588">
      </label>

      <p class="hint">
        ※ いずれも任意入力ですが、Wilson プロットには λ と θ_max が必要です。<br>
        ※ HKL のみでも解析できますが、正確な分解能計算が可能になります。
      </p>
    </section>

    <div class="panel">
      <h3>追加パラメータ（任意）</h3>

      <!-- ★ ID 揃え：meanZval（平均Z）をここでは未算出なので組成は保持だけ。 -->
      <label for="formulaInput">組成（元素情報）</label>
      <input id="formulaInput" name="formulaInput" placeholder="例: C12H10N2O3">

      <!-- ★ ID 揃え：params.js / getExperimentParams が参照する temperature -->
      <label for="temperature">測定温度 (K)</label>
      <input id="temperature" name="temperature" type="number" placeholder="例: 100">

      <!-- ★ ID 揃え：zprime -->
      <label for="zprime">Z′（独立分子数）</label>
      <input id="zprime" name="zprime" type="number" step="0.5" placeholder="例: 1">

      <!-- ★ ID 揃え：crystalSystem -->
      <label for="crystalSystem">結晶系（推定後に選択も可能）</label>
      <select id="crystalSystem">
        <option value="">自動推定に従う</option>
        <option value="triclinic">triclinic</option>
        <option value="monoclinic">monoclinic</option>
        <option value="orthorhombic">orthorhombic</option>
        <option value="tetragonal">tetragonal</option>
        <option value="trigonal">trigonal</option>
        <option value="hexagonal">hexagonal</option>
        <option value="cubic">cubic</option>
      </select>
    </div>

    <section class="panel">
      <h2>1) ファイル読み込み</h2>
      <input id="fileInput" type="file" accept=".hkl,.HKL,.txt"/>
      <p class="hint">想定フォーマット: <code>h k l I sigma</code> の空白区切り（行コメントや空行は自動スキップ）</p>
    </section>

    <section class="panel">
      <h2>2) 概要</h2>
      <div id="summary">ファイル未読込</div>
    </section>

    <section class="panel">
      <h2>3) 出力</h2>
      <button id="downloadEcsv" disabled>E 値 CSV をダウンロード</button>
      <button id="downloadFcsv" disabled>|F| CSV をダウンロード</button>
    </section>

    <section class="panel">
      <h2>Wilson-like プロット（近似：R = h²+k²+l²）</h2>
      <div id="wilsonContainer" style="overflow:auto">
        <!-- SVG をここに動的に生成 -->
      </div>
      <p class="hint">
        ※ ユニットセル未入力のため、d-spacing ではなく R=h²+k²+l² を横軸に用いた近似プロットです。<br>
        ※ 形状（高角側での落ち方）と品質の当たりを掴む目的に使えます。<br>
        ※ 絶対値ではなく“形”を見るためのプロットです。
      </p>
    </section>

    <section class="panel">
      <h2>E 分布ヒストグラム</h2>
      <div id="eHistContainer"></div>
      <p class="hint">
        ⟨|E²−1|⟩ に基づき、centro / acentro の推定を行います。<br>
        理想値：acentro ≈ 0.736, centro ≈ 0.968
      </p>
      <div id="pattersonContainer"></div>        <!-- 2D -->
      <div id="pattersonVolumeContainer"></div>  <!-- 3D -->
      <div id="rhoVolumeContainer"></div>        <!-- ρ(r) 3D -->
    </section>

    <section class="panel">
      <h2>系統消滅（Extinction）による格子心推定</h2>
      <div id="extContainer">未計算</div>
      <p class="hint">
        候補：P / I / C / F<br>
        ratio = forbidden / allowed が小さいほど格子心の可能性が高い。<br>
        ※ ロバスト統計（median + winsorize）により外れ値の影響を抑えています。
      </p>
    </section>

    <section class="panel">
      <h2>空間群候補（簡易）</h2>
      <div id="sgContainer"></div>

      <details id="voteSettings" style="margin-top:12px;">
        <summary>Voting weights（空間群候補の投票重み）</summary>
        <div class="settings-grid">
          <label>base <input type="range" min="0" max="0.5" step="0.01" data-key="base"></label>
          <label>centering <input type="range" min="0" max="2.0" step="0.01" data-key="center"></label>
          <label>glide <input type="range" min="0" max="2.0" step="0.01" data-key="glide"></label>
          <label>screw <input type="range" min="0" max="2.0" step="0.01" data-key="screw"></label>
          <label>E stats <input type="range" min="0" max="0.5" step="0.01" data-key="eStat"></label>
          <label>priorZ <input type="range" min="0" max="2.0" step="0.01" data-key="priorZ"></label>
          <label>temp <input type="range" min="0" max="2.0" step="0.01" data-key="temp"></label>
          <label>z′ <input type="range" min="0" max="2.0" step="0.01" data-key="zprime"></label>
        </div>
        <div style="margin-top:6px;">
          <button id="btnResetWeights">Reset to default</button>
        </div>
      </details>

      <p class="hint">
        格子心（I/C/F/P）と E分布（centro/acentro）に基づく初期推定。<br>
        完全な決定ではありませんが、SHELX の初期段階と同等の役割を持ちます。
      </p>
    </section>

    <section class="panel">
      <h2>進捗</h2>
      <div style="display:flex; align-items:center; gap:12px;">
        <progress id="progress" value="0" max="100" style="width: 320px;"></progress>
        <span id="progressPct">0%</span>
      </div>
      <div id="progressInfo" class="hint">待機中…</div>
    </section>

    <section class="panel">
      <h2>ログ</h2>
      <pre id="log"></pre>
    </section>
  </main>

  <footer>
    <small>© 2026 SHELX-Next Project（試作）</small>
  </footer>

  <!-- ★ 二重ロードを避ける：app.js が utils/* を import する前提で十分 -->
  <script type="module" src="./app.js"></script>

  <!-- ★ 投票重み UI（ローカル保存＋イベント発火） -->
  <script type="module">
    import { DEFAULT_WEIGHTS } from './utils/sg_vote.js';
    const root = document.getElementById('voteSettings');
    const inputs = [...root.querySelectorAll('input[type="range"][data-key]')];

    function load() {
      const saved = JSON.parse(localStorage.getItem('sg_vote_weights') || "null") || DEFAULT_WEIGHTS;
      inputs.forEach(inp => {
        const key = inp.dataset.key;
        inp.value = typeof saved[key] === 'number' ? saved[key] : DEFAULT_WEIGHTS[key];
        inp.title = `${key}: ${inp.value}`;
      });
    }
    function save() {
      const saved = JSON.parse(localStorage.getItem('sg_vote_weights') || "null") || DEFAULT_WEIGHTS;
      const out = { ...DEFAULT_WEIGHTS, ...saved };
      inputs.forEach(inp => {
        const key = inp.dataset.key;
        out[key] = Number(inp.value);
      });
      localStorage.setItem('sg_vote_weights', JSON.stringify(out));
      document.dispatchEvent(new CustomEvent('sg-weights-changed', { detail: out }));
    }
    load();
    inputs.forEach(inp =>
      inp.addEventListener('input', () => { inp.title = `${inp.dataset.key}: ${inp.value}`; save(); })
    );
    document.getElementById('btnResetWeights').addEventListener('click', () => {
      localStorage.removeItem('sg_vote_weights');
      load(); save();
    });
  </script>
</body>
</html>
